<%@page import="java.util.List,java.util.Arrays,java.util.Collections"%>
<%@page import="com.biosensetek.Utils,com.biosensetek.Validator,com.biosensetek.ResultUtil,com.biosensetek.DBUtils,com.biosensetek.WebUtils"%>
<%@page import="org.apache.commons.lang3.StringUtils"%>
<%@page import="com.google.gson.JsonObject"%>
<%@page import="java.sql.ResultSet,java.sql.Statement,java.sql.Connection"%>
<%@page contentType="text/html;charset=UTF-8" pageEncoding="UTF-8"%><%
Collections.list(request.getParameterNames()).forEach(n->{
	System.out.println(n+"="+request.getParameter(n));
});
if (session.getAttribute("licence") == null) {
	session.setAttribute("signin.html/return", request.getRequestURI());response.sendRedirect("signin.html");return;
}
int view = 0;
String oid = null;
if (StringUtils.equalsIgnoreCase("post", request.getMethod())) {
	 String act = StringUtils.trimToNull(request.getParameter("a"));
	 if (act != null && act.matches("^(?:new|add|upd|ret|dtl)$")) {
		 if ("new".equals(act)) {
			 request.setAttribute("o", Utils.obfuscate(Utils.uuid()));
			 request.setAttribute("a", "add");
			 view = 1;
		 } else if ("dtl".equals(act)) {
			 oid = Validator.create(request.getParameter("o")).regex("(?i)^[a-z0-9_-]{22}$").valid();
			 if(oid != null) {
				 request.setAttribute("o", oid);
				 request.setAttribute("a", "upd");
				 view = 1;
			 }
		 } else if ("ret".equals(act)) {
			 view = 0;
		 } else if ("add".equals(act) || "upd".equals(act)) {
			 oid = Validator.create(request.getParameter("o")).regex("(?i)^[a-z0-9_-]{22}$").valid();
			 String email = Validator.create(request.getParameter("m")).email().valid();
			 String account = Validator.create(request.getParameter("c")).regex("^[a-z]{4,10}$").valid();
			 String grp = Validator.create(request.getParameter("g")).regex("^[a-f0-9]{32}$").valid();
			 String title = StringUtils.trimToNull(request.getParameter("t"));
			 String name = StringUtils.trimToNull(request.getParameter("n"));
			 if (oid != null && email!=null && account!=null && grp != null && title!=null && name!=null) {
				 try (Connection conn = DBUtils.conn("main")) {
					 StringBuilder sql = new StringBuilder();
					 if ("add".equals(act)) {
						 sql
						 .append("INSERT IGNORE INTO usr(uid,account,display,name,email,pwd,title,grp,cr)SELECT")
						 .append("'").append(Utils.$obfuscate(oid)).append("',")
						 .append("'").append(account).append("',")
						 .append("'").append(StringUtils.capitalize(account)).append("',")
						 .append("'").append(name).append("',")
						 .append("'").append(email).append("',")
						 .append("'").append(Utils.protect(new StringBuilder(account).append("0000").toString())).append("',")
						 .append("'").append(title).append("',")
						 .append("'").append(grp).append("',NOW()");
					 } else {
						 sql
						 .append("UPDATE usr SET")
						 .append( " name='").append(name).append("',")
						 .append( "email='").append(email).append("',")
						 .append( "title='").append(title).append("',")
						 .append(   "grp='").append(grp).append("',up=NOW()")
						 .append(" WHERE uid='").append(Utils.$obfuscate(oid)).append("'");
					 }
					 try (Statement stat = conn.createStatement()) {
						 stat.executeUpdate(sql.toString());
						 view = 0;
					 }
				 } catch (Exception ex){ex.printStackTrace();}
			 } else {
				 request.setAttribute("warning", "帳戶資料有誤，請檢查後再試");
			 }
		 }
	 }
}
//
try (Connection conn = DBUtils.conn("main")) {
	try (Statement stat = conn.createStatement()) {
		if (view==0) {
			try (ResultSet rs = stat.executeQuery("SELECT COUNT(0)`found`FROM usr WHERE status>=0")) {
				ResultUtil.attr(rs, request);
			}
			try (ResultSet rs = stat.executeQuery("SELECT uid,account,display,name,status FROM usr WHERE status>=0")) {
				request.setAttribute("usrs", ResultUtil.jsonlist(rs));
			}
		} else if (view==1 && "dtl".equals(request.getParameter("a"))) {
			StringBuilder sql = new StringBuilder();sql
			.append("SELECT uid,account,display,email,name,title,status")
			.append( " FROM usr WHERE status>=0")
			.append(  " AND uid='").append(Utils.$obfuscate(oid)).append("'");
			System.out.println(sql);
			try (ResultSet rs = stat.executeQuery(sql.toString())) {
				ResultUtil.attr(rs, request);
			}
		}
		try (ResultSet rs = stat.executeQuery("SELECT uid,name FROM grp WHERE status=1")) {
			request.setAttribute("grps", ResultUtil.jsonlist(rs));
		}
	}
}

%><!DOCTYPE html><html><head><meta charset="UTF-8"><title>帳號管理</title></head>
<body>
<div class="wrapper wrapper-content animated fadeInRight">
<%if (view==0) {%>
	<div class="row">
	   <div class="col-lg-12">
	       <div class="ibox float-e-margins">
	           <div class="ibox-content">
	               <form role=form class=form-inline>
	                   <div class="form-group">
	                       <label class=sr-only>Email address</label>
	                       <input type="email" placeholder="Enter email" class=form-control>
	                   </div>
	                   <div class=form-group>
	                       <label class="sr-only">Password</label>
	                       <input type="text" placeholder="Password" class=form-control>
	                   </div>
	                   <div class=form-group>
	                       <label class="sr-only">Password</label>
	                       <select class=form-control>
	                       <%for (JsonObject j : (List<JsonObject>) request.getAttribute("grps")) {%>
	                       <option value=<%=j.get("uid").getAsString()%>><%=j.get("name").getAsString()%></option>
	                       <%} %>
	                       </select>
	                   </div>
	                   <button class="btn btn-white" type=submit>搜尋</button>
	               </form>
	           </div>
	       </div>
	   </div>
	</div>
   <div class=row>
      <div class=col-lg-12>
         <div class="ibox float-e-margins">
            <div class=ibox-title>
            </div>
            <div class=ibox-content>
               <div class="table-responsive">
                  <div class="dataTables_wrapper form-inline dt-bootstrap">
                     <div>共 ${found} 筆</div>
                     <table class="table table-striped table-bordered" role=grid>
                        <thead>
                           <tr role=row><th>項次</th><th>帳號</th><th>顯示</th><th>姓名</th><th>狀態</th>
                              <th style="width:180px;"><a href="#" class=new><i class="fa fa-plus text-warning"></i></a></th>
                           </tr>
                        </thead>
                        <tbody><%int i=0;
                        for (JsonObject j : (List<JsonObject>) request.getAttribute("usrs")) {%>
                           <tr class=odd role=row>
                              <td><%=(++i)%></td><td><%=j.get("account").getAsString()%></td><td><%=j.get("display").getAsString()%></td><td><%=j.get("name").getAsString()%></td>
                              <td><span class="badge badge-primary">使用中</span></td>
                              <td data-id=<%=Utils.obfuscate(j.get("uid").getAsString())%>><a href="#"><i class="fa fa-cog text-navy"></i></a>&nbsp;
                              <a href="#" class=dtl><i class="fa fa-pencil text-success"></i></a>
                              </td>
                           </tr>
                        <%}
                        %></tbody>
                     </table>
                     <div class="dataTables_paginate"><jsp:include page="/WEB-INF/unit/pager.jsp"/></div>
                  </div>
               </div>
            </div>
         </div>
      </div>
   </div>
<%} else if (view ==1) { %>
<div class=row>
<div class=col-lg-12>
	<div class="ibox float-e-margins">
		<div class=ibox-title><h5>Horizontal form</h5></div>
		<div class=ibox-content>
			<form class="form-horizontal" method=post action=<%=request.getRequestURI()%>>
				<input type=hidden name=o value=${o}>
				<p>Sign in today for more expirience.</p>
				<div class=form-group><label class="col-lg-2 control-label">帳號</label>
					<div class=col-lg-10><input type=text placeholder=帳號 name=c class=form-control value=${account}></div>
				</div>
				<div class=form-group><label class="col-lg-2 control-label">Email</label>
					<div class=col-lg-10><input type=email placeholder=Email name=m class=form-control value=${email}></div>
				</div>
				<div class=form-group><label class="col-lg-2 control-label">姓名</label>
					<div class=col-lg-10><input type=text placeholder=姓名 name=n class=form-control value=${name}></div>
				</div>
				<div class=form-group><label class="col-lg-2 control-label">職稱</label>
					<div class=col-lg-10><input type=text placeholder=職稱 name=t class=form-control value=${title}></div>
				</div>
				<div class=form-group><label class="col-lg-2 control-label">群組</label>
					<div class=col-lg-10>
					<select name=g><%
					for (JsonObject j : (List<JsonObject>) request.getAttribute("grps")) {%>
                     <option value=<%=j.get("uid").getAsString()%>><%=j.get("name").getAsString()%></option>
                     <%}
					%></select>
					</div>
				</div>
				<div class=form-group>
					<div class="col-lg-offset-2 col-lg-10">
						<button class="btn btn-sm btn-primary" type=submit name=a value=<%=StringUtils.defaultIfBlank((String) request.getAttribute("a"), "upd")%>>儲存</button>
						<button class="btn btn-sm btn-white" name=a value=ret>返回</button>
					</div>
				</div>
			</form>
		</div>
	</div>
</div>
</div>
<%} %>
</div>
</body>
</html><%
request.setAttribute("breadcrumb", Arrays.asList("帳號管理"));
%>
<%out = WebUtils.script(request, out);%>
<script>
(function($){
$(document).ready(function(){
	$(".new").on('click',function(){
		$('<form method=post action=<%=request.getRequestURI()%>><input type=hidden name=a value=new></form>').appendTo('body').submit();
	});
	$(".dtl").on('click',function(){
		$(['<form method=post action=<%=request.getRequestURI()%>><input type=hidden name=a value=dtl><input type=hidden name=o value=',$(this).closest('td').attr('data-id'),'></form>'].join('')).appendTo('body').submit();
	});
});})(jQuery);
</script>
<%out = WebUtils.script(out);%>
